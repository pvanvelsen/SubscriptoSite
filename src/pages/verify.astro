---
import BaseLayout from '../layouts/BaseLayout.astro';
import Logo from '../components/Logo.astro';

// Server-side: Check for error query parameters (Supabase sends errors as query params)
const url = Astro.url;
const error = url.searchParams.get('error');
const errorDescription = url.searchParams.get('error_description');

// If there's an error in query params, show error state
// Otherwise, we need to check hash fragment client-side
const hasServerError = !!error;
---

<BaseLayout
  title="Email Verification"
  description="Email verification for Subscriptin account"
>
  <div class="min-h-screen flex flex-col items-center justify-center page-padding py-20">
    <div class="w-full max-w-2xl mx-auto text-center content-padding">

      <!-- Logo -->
      <div class="logo-spacing">
        <Logo size="large" />
      </div>

      <!-- Loading State (shown while checking hash fragment) -->
      <div id="loading-state" style={hasServerError ? 'display: none;' : ''}>
        <!-- Loading Icon -->
        <div class="flex justify-center icon-spacing">
          <div class="icon-circle rounded-full bg-[var(--color-primary-container)] dark:bg-[var(--color-primary-container-dark)] flex items-center justify-center">
            <svg class="icon-svg text-[var(--color-primary)] dark:text-[var(--color-primary-dark)] animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </div>

        <h1 class="display-small heading-spacing">Verifying...</h1>
        <p class="title-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)] leading-relaxed">
          Please wait while we confirm your email address.
        </p>
      </div>

      <!-- Success State -->
      <div id="success-state" style="display: none;">
        <!-- Success Icon -->
        <div class="flex justify-center icon-spacing">
          <div class="icon-circle rounded-full bg-[var(--color-secondary)] dark:bg-[var(--color-secondary-dark)] flex items-center justify-center">
            <svg
              class="icon-svg text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>
        </div>

        <!-- Success Message -->
        <h1 class="display-small heading-spacing">
          Email Verified!
        </h1>
        <p class="title-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)] leading-relaxed description-spacing">
          Your email has been successfully confirmed.
        </p>

        <!-- Instructions -->
        <div class="instructions-container" style="max-width: 36rem; margin: 0 auto; text-align: center;">
          <p class="body-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)] leading-relaxed instruction-spacing">
            You can now close this page and return to the Subscriptin app to continue setting up your account.
          </p>

          <!-- Open App Button -->
          <button
            id="openAppBtn"
            class="button-spacing bg-[var(--color-primary)] dark:bg-[var(--color-primary-dark)] text-white rounded-full title-large font-medium hover:opacity-90 active:scale-[0.98] transition-all elevation-2 hover:elevation-3 flex items-center justify-center gap-3"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <span>Open Subscriptin App</span>
          </button>

          <!-- Fallback Link -->
          <p class="body-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)]">
            App not installed?{' '}
            <a
              href="/"
              class="text-[var(--color-primary)] dark:text-[var(--color-primary-dark)] underline hover:opacity-80 font-medium transition-opacity"
            >
              Download here
            </a>
          </p>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" style={hasServerError ? '' : 'display: none;'}>
        <!-- Error Icon -->
        <div class="flex justify-center icon-spacing">
          <div class="icon-circle rounded-full bg-[var(--color-error)] dark:bg-[var(--color-error-dark)] flex items-center justify-center">
            <svg
              class="icon-svg text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
          </div>
        </div>

        <!-- Error Message -->
        <h1 class="display-small heading-spacing">
          Verification Failed
        </h1>
        <p id="error-message" class="title-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)] leading-relaxed description-spacing">
          {errorDescription || error || 'Something went wrong. Please try again.'}
        </p>

        <!-- Error Actions -->
        <div class="instructions-container" style="max-width: 36rem; margin: 0 auto; text-align: center;">
          <p class="body-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)] leading-relaxed instruction-spacing">
            This verification link may have expired or already been used.
          </p>

          <a
            href="/"
            class="button-spacing inline-flex items-center justify-center bg-[var(--color-primary)] dark:bg-[var(--color-primary-dark)] text-white rounded-full title-large font-medium hover:opacity-90 active:scale-[0.98] transition-all elevation-2 hover:elevation-3 gap-3"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            <span>Return to Home</span>
          </a>

          <p class="body-large text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)]">
            Need help?{' '}
            <a
              href="mailto:hello@subscriptin.io"
              class="text-[var(--color-primary)] dark:text-[var(--color-primary-dark)] underline hover:opacity-80 font-medium transition-opacity"
            >
              Contact support
            </a>
          </p>
        </div>
      </div>

      <!-- Footer -->
      <footer class="footer-spacing border-t border-[var(--color-outline-variant)] dark:border-[var(--color-outline-variant-dark)]">
        <p class="body-medium text-[var(--color-on-surface-variant)] dark:text-[var(--color-on-surface-variant-dark)]">
          Â© 2024 Subscriptin. All rights reserved.
        </p>
      </footer>
    </div>
  </div>
</BaseLayout>

<style>
  /* Page padding */
  .page-padding {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }

  .content-padding {
    padding-left: 1rem;
    padding-right: 1rem;
  }

  /* Desktop spacing (default) */
  .logo-spacing {
    margin-bottom: 5rem;
  }

  .icon-spacing {
    margin-bottom: 3rem;
  }

  .icon-circle {
    width: 12rem;
    height: 12rem;
  }

  .icon-svg {
    width: 6rem;
    height: 6rem;
  }

  .heading-spacing {
    margin-bottom: 1.5rem;
  }

  .description-spacing {
    margin-bottom: 3rem;
  }

  .instruction-spacing {
    margin-bottom: 2rem;
  }

  .button-spacing {
    width: 100%;
    padding: 1.25rem 3rem;
    margin-bottom: 2rem;
  }

  .footer-spacing {
    margin-top: 8rem;
    padding-top: 3rem;
  }

  /* Mobile spacing (640px and below) */
  @media (max-width: 640px) {
    .logo-spacing {
      margin-bottom: 2.5rem;
    }

    .icon-spacing {
      margin-bottom: 2rem;
    }

    .icon-circle {
      width: 8rem;
      height: 8rem;
    }

    .icon-svg {
      width: 4rem;
      height: 4rem;
    }

    .heading-spacing {
      margin-bottom: 1rem;
    }

    .description-spacing {
      margin-bottom: 2rem;
    }

    .instruction-spacing {
      margin-bottom: 1.5rem;
    }

    .button-spacing {
      padding: 1rem 2rem;
      margin-bottom: 1.5rem;
    }

    .footer-spacing {
      margin-top: 4rem;
      padding-top: 2rem;
    }
  }

  /* Very small mobile (400px and below) */
  @media (max-width: 400px) {
    .logo-spacing {
      margin-bottom: 2rem;
    }

    .icon-circle {
      width: 6rem;
      height: 6rem;
    }

    .icon-svg {
      width: 3rem;
      height: 3rem;
    }

    .button-spacing {
      padding: 0.875rem 1.5rem;
    }
  }
</style>

<script>
  // Parse hash fragment from URL (Supabase sends tokens in hash)
  function parseHashFragment() {
    const hash = window.location.hash.substring(1); // Remove the '#'
    if (!hash) return null;

    const params: Record<string, string> = {};
    hash.split('&').forEach(pair => {
      const [key, value] = pair.split('=');
      if (key && value) {
        params[decodeURIComponent(key)] = decodeURIComponent(value);
      }
    });
    return params;
  }

  // Check verification status from hash fragment
  function checkVerificationStatus() {
    const loadingState = document.getElementById('loading-state');
    const successState = document.getElementById('success-state');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');

    // If error state is already visible (server-side error), don't check hash
    if (errorState && errorState.style.display !== 'none') {
      if (loadingState) loadingState.style.display = 'none';
      return;
    }

    const params = parseHashFragment();

    // Check for success: access_token present and type is signup/email
    const isSuccess = params && params.access_token &&
      (params.type === 'signup' || params.type === 'email' || params.type === 'magiclink');

    // Check for error in hash
    const hasError = params && params.error;

    if (loadingState) loadingState.style.display = 'none';

    if (isSuccess) {
      if (successState) successState.style.display = '';
      if (errorState) errorState.style.display = 'none';

      // Update page title
      document.title = 'Email Verified | Subscriptin';

      // Setup app opening functionality
      setupAppOpening(params.access_token);
    } else {
      if (successState) successState.style.display = 'none';
      if (errorState) errorState.style.display = '';

      // Update error message if there's one in the hash
      if (hasError && errorMessage) {
        const description = params.error_description || params.error || 'Something went wrong. Please try again.';
        errorMessage.textContent = description;
      }

      // Update page title
      document.title = 'Verification Failed | Subscriptin';
    }
  }

  function setupAppOpening(accessToken: string) {
    const openAppBtn = document.getElementById('openAppBtn');
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    function openApp() {
      // Create deep link with the access token
      const deepLink = `subscriptin://auth/callback#access_token=${encodeURIComponent(accessToken)}`;

      // Attempt to open the app
      window.location.href = deepLink;

      // Fallback: If app doesn't open after 2 seconds, show message
      if (isMobile) {
        setTimeout(() => {
          if (document.visibilityState === 'visible') {
            // App didn't open - user might not have it installed
            // Don't redirect, let them use the download link
          }
        }, 2000);
      }
    }

    // Add click handler to button
    if (openAppBtn) {
      openAppBtn.addEventListener('click', openApp);
    }

    // Auto-open app after 2 seconds on mobile
    if (isMobile) {
      setTimeout(() => {
        openApp();
      }, 2000);
    }
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkVerificationStatus);
  } else {
    checkVerificationStatus();
  }
</script>
